<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>CSRF of WebApp Frameworks</title>
  <meta name="description" content="wait.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://ironhead.bitbucket.com/2015/01/31/webapp-csrf.html">

  <script type="text/javascript"
           src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">iRonhead</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
            
              <a class="page-link" href="/about/">About</a>
            
          
        
          
            
              <a class="page-link" href="/cv/">CV</a>
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              <a class="page-link" href="/projects/">Projects</a>
            
          
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">CSRF of WebApp Frameworks</h1>
    <p class="post-meta">Jan 31, 2015</p>
  </header>

  <article class="post-content">
    <h1 id="csrf-protection-in-rails-4-2-stable">CSRF Protection in Rails (4-2-stable)</h1>

<h2 id="generate">Generate</h2>
<p>In rails, we can find a csrf token in the head of html or a hidden input of forms:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="tag">&lt;html&gt;</span>
  <span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">csrf-token</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">V6CZMZGA+lnkmonZbw74c81KAGjBAlK6Jk1UEbQkW95zjIMxU/G5ixcbokIG5GIzlG2gwtag4la/eLoTXT6/Dw==</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;/head&gt;</span>
  <span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;form&gt;</span>
      <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticity_token</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OFkGlN+ho64ffPlNEJ7P01VPO+dC7yQ96rl13pKNV8McdRyUHdDgfOz90tZ5dFWTDGibTVVNlNFzjJvce5ezEg==</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/form&gt;</span>
  <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span>
</pre></div>
</div>
</div>

<p>Those tokens are generated in <a href="https://github.com/rails/rails/blob/4-2-stable/actionpack/lib/action_controller/metal/request_forgery_protection.rb">ActionController</a>
and not predictable (thatâ€™s what we need for csrf protection).
In <a href="https://github.com/rails/rails/blob/4-2-stable/actionview/lib/action_view/helpers/csrf_helper.rb">ActionView module</a> we can find how csrf meta tags are generated:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="keyword">def</span> <span class="function">csrf_meta_tags</span>
  <span class="keyword">if</span> protect_against_forgery?
    [
      tag(<span class="string"><span class="delimiter">'</span><span class="content">meta</span><span class="delimiter">'</span></span>, <span class="symbol">:name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">csrf-param</span><span class="delimiter">'</span></span>, <span class="symbol">:content</span> =&gt; request_forgery_protection_token),
      tag(<span class="string"><span class="delimiter">'</span><span class="content">meta</span><span class="delimiter">'</span></span>, <span class="symbol">:name</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">csrf-token</span><span class="delimiter">'</span></span>, <span class="symbol">:content</span> =&gt; form_authenticity_token)
    ].join(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>).html_safe
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></div>
</div>
</div>

<p>The methods <strong>form_authenticity_token</strong> is in <a href="https://github.com/rails/rails/blob/4-2-stable/actionpack/lib/action_controller/metal/request_forgery_protection.rb">ActionController</a> :</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="constant">AUTHENTICITY_TOKEN_LENGTH</span> = <span class="integer">32</span>

<span class="keyword">def</span> <span class="function">form_authenticity_token</span>
  masked_authenticity_token(session)
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">masked_authenticity_token</span>(session)
  one_time_pad = <span class="constant">SecureRandom</span>.random_bytes(<span class="constant">AUTHENTICITY_TOKEN_LENGTH</span>)
  encrypted_csrf_token = xor_byte_strings(one_time_pad, real_csrf_token(session))
  masked_token = one_time_pad + encrypted_csrf_token
  <span class="constant">Base64</span>.strict_encode64(masked_token)
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">valid_authenticity_token?</span>(session, encoded_masked_token)
  <span class="keyword">return</span> <span class="predefined-constant">false</span> <span class="keyword">if</span> encoded_masked_token.nil? || encoded_masked_token.empty?

  <span class="keyword">begin</span>
    masked_token = <span class="constant">Base64</span>.strict_decode64(encoded_masked_token)
  <span class="keyword">rescue</span> <span class="constant">ArgumentError</span> <span class="comment"># encoded_masked_token is invalid Base64</span>
    <span class="keyword">return</span> <span class="predefined-constant">false</span>
  <span class="keyword">end</span>

  <span class="comment"># See if it's actually a masked token or not. In order to</span>
  <span class="comment"># deploy this code, we should be able to handle any unmasked</span>
  <span class="comment"># tokens that we've issued without error.</span>

  <span class="keyword">if</span> masked_token.length == <span class="constant">AUTHENTICITY_TOKEN_LENGTH</span>
    <span class="comment"># This is actually an unmasked token. This is expected if</span>
    <span class="comment"># you have just upgraded to masked tokens, but should stop</span>
    <span class="comment"># happening shortly after installing this gem</span>
    compare_with_real_token masked_token, session

  <span class="keyword">elsif</span> masked_token.length == <span class="constant">AUTHENTICITY_TOKEN_LENGTH</span> * <span class="integer">2</span>
    <span class="comment"># Split the token into the one-time pad and the encrypted</span>
    <span class="comment"># value and decrypt it</span>
    one_time_pad = masked_token[<span class="integer">0</span>...<span class="constant">AUTHENTICITY_TOKEN_LENGTH</span>]
    encrypted_csrf_token = masked_token[<span class="constant">AUTHENTICITY_TOKEN_LENGTH</span>..<span class="integer">-1</span>]
    csrf_token = xor_byte_strings(one_time_pad, encrypted_csrf_token)

    compare_with_real_token csrf_token, session

  <span class="keyword">else</span>
    <span class="predefined-constant">false</span> <span class="comment"># Token is malformed</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">def</span> <span class="function">real_csrf_token</span>(session)
  session[<span class="symbol">:_csrf_token</span>] ||= <span class="constant">SecureRandom</span>.base64(<span class="constant">AUTHENTICITY_TOKEN_LENGTH</span>)
  <span class="constant">Base64</span>.strict_decode64(session[<span class="symbol">:_csrf_token</span>])
<span class="keyword">end</span>
</pre></div>
</div>
</div>

<p>In brief, a token is generated by this steps:</p>

<ul>
  <li>For each session, a random 32 bytes long token in base 64 is generated (44 long).</li>
  <li>Decode this token with base64 (to 32 bytes binary token).</li>
  <li>Everytime when we need a form authenticity token, a 32 bytes one time pad is generated.</li>
  <li>XOR one time pad and csrf token to encrypted_csrf_token.</li>
  <li>Concatenate csrf token and encrypted_csrf_token (32 + 32 = 64 bytes).</li>
  <li>Encode the result in base64 give us the final csrf token (64 * (4/3) = 88 bytes).</li>
</ul>

<h2 id="code-tracing-verification">Code tracing verification</h2>

<p>Now open a rails site in browser and find the csrf token, refresh the page to get 2 different tokens.
In rails console def a decode method and pass those tokens to see the result. The result should be the same.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="comment"># extract from valid_authenticity_token?</span>
<span class="keyword">def</span> <span class="function">decode</span>(token)
  token = <span class="constant">Base64</span>.strict_decode64 token
  t1 = token[<span class="integer">0</span>...<span class="integer">32</span>]
  t2 = token[<span class="integer">32</span>..<span class="integer">-1</span>]
  t1.bytes.zip(t2.bytes).map { |(c1,c2)| c1 ^ c2 }.pack(<span class="string"><span class="delimiter">'</span><span class="content">c*</span><span class="delimiter">'</span></span>)
<span class="keyword">end</span>
</pre></div>
</div>
</div>

<p>Then re-launch the browser and decode another token, the result should be changed (bound to session!).</p>

<h1 id="csrf-protection-in-nodejs">CSRF Protection in Nodejs</h1>

<p>In <a href="https://github.com/expressjs/csurf/blob/master/index.js">CSURF middleware</a>, a secret is generated
using secretSync method of <a href="https://github.com/pillarjs/csrf/blob/master/index.js">csrf module</a> which return
pseudo random bytes.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="comment">// generate &amp; set new secret</span>
<span class="keyword">if</span> (sec === <span class="predefined-constant">undefined</span>) {
  sec = tokens.secretSync()
  setsecret(req, res, sec, cookie)
}
</pre></div>
</div>
</div>

<p>Then in <a href="https://github.com/pillarjs/csrf/blob/master/index.js">csrf module</a>, use tokenize method to generate
the final token:</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>csrfTokens.<span class="function">tokenize</span> = <span class="keyword">function</span> <span class="function">tokenize</span>(secret, salt) {
  <span class="keyword">var</span> hash = escape(crypto
    .createHash(<span class="string"><span class="delimiter">'</span><span class="content">sha1</span><span class="delimiter">'</span></span>)
    .update(salt)
    .update(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)
    .update(secret)
    .digest(<span class="string"><span class="delimiter">'</span><span class="content">base64</span><span class="delimiter">'</span></span>))
  <span class="keyword">return</span> salt + <span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span> + hash
}
</pre></div>
</div>
</div>

<p>To verify the token, re-generate the token with salt and secret and compare the result. As in the
tokenize method, salt is in the beginning of the final token and hash is generated base on salt and
the pseudo randome secret.</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="function">verify</span>: <span class="keyword">function</span> <span class="function">verify</span>(secret, token) {
  <span class="keyword">if</span> (!secret || <span class="keyword">typeof</span> secret !== <span class="string"><span class="delimiter">'</span><span class="content">string</span><span class="delimiter">'</span></span>) {
    <span class="keyword">return</span> <span class="predefined-constant">false</span>
  }

  <span class="keyword">if</span> (!token || <span class="keyword">typeof</span> token !== <span class="string"><span class="delimiter">'</span><span class="content">string</span><span class="delimiter">'</span></span>) {
    <span class="keyword">return</span> <span class="predefined-constant">false</span>
  }

  <span class="keyword">var</span> index = token.indexOf(<span class="string"><span class="delimiter">'</span><span class="content">-</span><span class="delimiter">'</span></span>)

  <span class="keyword">if</span> (index === -<span class="integer">1</span>) {
    <span class="keyword">return</span> <span class="predefined-constant">false</span>
  }

  <span class="keyword">var</span> salt = token.substr(<span class="integer">0</span>, index)
  <span class="keyword">var</span> expected = tokenize(secret, salt)

  <span class="keyword">return</span> scmp(token, expected)
}
</pre></div>
</div>
</div>

<h2 id="code-tracing-verification-1">Code tracing verification</h2>

<p>Can not verify if we donâ€™t known the secret.</p>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://github.com/rails/rails/blob/4-2-stable/actionpack/lib/action_controller/metal/request_forgery_protection.rb">Rails ActionController</a></li>
  <li><a href="https://github.com/pillarjs/csrf/blob/master/index.js">Nodejs CSRF</a></li>
  <li><a href="https://github.com/expressjs/csurf/blob/master/index.js">Nodejs CSURF</a></li>
</ul>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">iRonhead</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>iRonhead</li>
          <li><a href="mailto:ironhead.chuang@gmail.com">ironhead.chuang@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">wait.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
